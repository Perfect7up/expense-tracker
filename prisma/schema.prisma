generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/* =========================
   USER
========================= */
model User {
  id            String         @id @default(uuid())
  email         String         @unique
  name          String?
  avatarUrl     String?
  supabaseId    String?        @unique
  createdAt     DateTime       @default(now())

  categories    Category[]
  expenses      Expense[]
  incomes       Income[]
  subscriptions Subscription[]
  investments   Investment[]
}

/* =========================
   CATEGORY
========================= */
model Category {
  id            String         @id @default(uuid())
  name          String
  type          CategoryType
  userId        String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  user          User?          @relation(fields: [userId], references: [id], onDelete: Cascade)

  expenses      Expense[]
  incomes       Income[]
  subscriptions Subscription[]
  investments   Investment[]

  @@unique([userId, name, type])
  @@index([userId])
}

/* =========================
   INVESTMENT
========================= */
model Investment {
  id               String    @id @default(uuid())
  userId           String
  categoryId       String?

  name             String
  symbol           String?

  quantity         Decimal   @default(0) @db.Decimal(20, 10)
  averageBuyPrice  Decimal   @default(0) @db.Decimal(12, 2)
  currentPrice     Decimal?  @db.Decimal(12, 2)

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category         Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  expenses         Expense[]
  incomes          Income[]

  @@index([userId])
  @@index([categoryId])
}

/* =========================
   EXPENSE
========================= */
model Expense {
  id             String        @id @default(uuid())
  userId         String
  categoryId     String?
  subscriptionId String?
  investmentId   String?

  amount         Decimal       @db.Decimal(12, 2)
  currency       String        @default("USD")
  note           String?
  occurredAt     DateTime

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  category       Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
investment     Investment?   @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  @@index([userId, occurredAt])
  @@index([categoryId])
  @@index([subscriptionId])
  @@index([investmentId])
}

/* =========================
   INCOME
========================= */
model Income {
  id           String        @id @default(uuid())
  userId       String
  categoryId   String?
  investmentId String?

  amount       Decimal       @db.Decimal(12, 2)
  currency     String        @default("USD")
  source       String?
  note         String?
  receivedAt   DateTime

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  category     Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
investment     Investment?   @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  @@index([userId, receivedAt])
  @@index([categoryId])
  @@index([investmentId])
}

/* =========================
   SUBSCRIPTION
========================= */
model Subscription {
  id          String       @id @default(uuid())
  userId      String
  categoryId  String?

  name        String
  amount      Decimal      @db.Decimal(12, 2)
  currency    String       @default("USD")
  cycle       BillingCycle

  startDate   DateTime
  nextBilling DateTime
  endDate     DateTime?

  isActive    Boolean      @default(true)
  autoExpense Boolean      @default(true)
  note        String?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  category    Category?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  expenses    Expense[]

  @@index([userId])
  @@index([nextBilling])
}

/* =========================
   ENUMS
========================= */
enum CategoryType {
  EXPENSE
  INCOME
  INVESTMENT
}

enum BillingCycle {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}
